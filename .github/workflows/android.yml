name: android-build

on:
  push:
    branches: [android]
  workflow_dispatch: {}

jobs:
  apk:
    # Use Ubuntu 22.04 to avoid libtinfo5 package issues in Ubuntu 24.04
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python for testing
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: Install UV package manager
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install dependencies for testing
      run: |
        uv sync --extra dev
        
    - name: Run smoke tests
      run: |
        uv run python -m pytest tests/ -v
        
    - name: Build with Buildozer (with retry)
      run: |
        # Simple retry mechanism for network issues
        for attempt in 1 2 3; do
          echo "Build attempt $attempt/3"
          if timeout 1800 docker run --rm -v "$PWD":/app -w /app \
            -e ANDROID_ACCEPT_SDK_LICENSE=True \
            kivy/buildozer:latest \
            buildozer android debug; then
            echo "Build successful on attempt $attempt"
            break
          else
            exit_code=$?
            if [ $attempt -eq 3 ]; then
              echo "Build failed after 3 attempts"
              exit $exit_code
            else
              echo "Build attempt $attempt failed, retrying in 30 seconds..."
              sleep 30
            fi
          fi
        done
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          .buildozer/
          *.log
        retention-days: 7 